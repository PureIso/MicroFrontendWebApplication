server {
    listen 4200;
    server_name frontend;

    # Serve the main application (index.html)
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;  # Ensure static files are correctly served
    }

    # Proxy for the remote frontend application with CORS headers
    location /remoteFrontendWebApplication {
        proxy_pass http://remote:4201;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept';
        add_header 'Access-Control-Allow-Credentials' 'true';
    }

    # Serve CSS, JS, and other static assets for remote application
    location ~* ^/remoteFrontendWebApplication/.*\.(css|js|woff2|json)$ {
        proxy_pass http://remote:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin "*";
    }

    # Serve JavaScript files with the correct MIME type (single setting)
    location ~* \.js$ {
        root /usr/share/nginx/html;
        default_type application/javascript;
        try_files $uri =404;
        add_header Access-Control-Allow-Origin "*";
    }
    location ~* ^/remoteFrontendWebApplication/.*\.js$ {
        root /usr/share/nginx/html;
        default_type application/javascript;
        try_files $uri =404;
        add_header Access-Control-Allow-Origin "*";
    }

    # Serve hashed CSS files
    location ~* \.css$ {
        root /usr/share/nginx/html;
        default_type text/css;
        try_files $uri =404;  # Ensure the file exists
        add_header Access-Control-Allow-Origin "*";
    }
    location ~* ^/remoteFrontendWebApplication/.*\.css$ {
        root /usr/share/nginx/html;
        default_type text/css;
        try_files $uri =404;  # Ensure the file exists
        add_header Access-Control-Allow-Origin "*";
    }

    # Serve the remoteEntry.json with the correct MIME type
    location /remoteEntry.json {
        root /usr/share/nginx/html;
        default_type application/json;
        try_files $uri =404;
        add_header Access-Control-Allow-Origin "*";
    }
    location ~* \.json$ {
        root /usr/share/nginx/html;
        default_type application/json;
        try_files $uri =404;  # Ensure the file exists
        add_header Access-Control-Allow-Origin "*";
    }

    # Serve other static assets with correct MIME types
    location ~* \.(html|woff2)$ {
        root /usr/share/nginx/html;
        try_files $uri =404;
        add_header Access-Control-Allow-Origin "*";
    }

    # Global CORS headers
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";
}
